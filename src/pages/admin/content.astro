---
import { z } from "zod";
import AdminLayout from "../../layouts/AdminLayout.astro";
import { ensureAdminTables, verifyPassword } from "../../utils/auth";
import { ensureCoreTables } from "../../utils/db";

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const url = new URL(Astro.request.url);
const saved = url.searchParams.get("saved") === "1";
const savedImg = url.searchParams.get("img") === "1";
const hasR2 = Boolean(env?.R2);

const defaults = {
    hero_title: "Desenvolvedor Full Stack",
    hero_subtitle:
        "Especialista em criar soluções modernas, escaláveis e esteticamente agradáveis. Focando agora em infraestrutura Cloudflare e experiência do usuário.",
    hero_cta_experience: "Ver Experiência",
    hero_cta_certifications: "Certificações",
    hero_image_key: "",
};

const contentSchema = z.object({
    hero_title: z.string().min(3, "Título muito curto."),
    hero_subtitle: z.string().min(10, "Subtítulo muito curto."),
    hero_cta_experience: z.string().min(2, "CTA inválido."),
    hero_cta_certifications: z.string().min(2, "CTA inválido."),
    password: z.string().min(8, "Senha obrigatória."),
});

let errorMessage = "";

async function loadContent() {
    if (env?.DB) {
        await ensureCoreTables(env);
    }

    if (!env?.DB) return defaults;
    const { results } = await env.DB.prepare(
        "SELECT key, value FROM site_content WHERE key IN ('hero_title','hero_subtitle','hero_cta_experience','hero_cta_certifications','hero_image_key')",
    ).all();
    const map: Record<string, string> = {};
    results?.forEach((row: any) => {
        map[row.key] = row.value;
    });
    return { ...defaults, ...map };
}

if (Astro.request.method === "POST" && env?.DB) {
    try {
        await ensureAdminTables(env);
        await ensureCoreTables(env);
        const data = await Astro.request.formData();
        const parsed = contentSchema.safeParse({
            hero_title: data.get("hero_title"),
            hero_subtitle: data.get("hero_subtitle"),
            hero_cta_experience: data.get("hero_cta_experience"),
            hero_cta_certifications: data.get("hero_cta_certifications"),
            password: data.get("password"),
        });

        if (!parsed.success) {
            errorMessage = parsed.error.issues[0]?.message || "Dados inválidos.";
        } else {
            const { password, ...payload } = parsed.data;
            const passwordOk = await verifyPassword(password, env);
            if (!passwordOk) {
                throw new Error("Senha incorreta. Somente ações autenticadas podem salvar alterações.");
            }

            const entries: [string, string][] = [
                ["hero_title", payload.hero_title],
                ["hero_subtitle", payload.hero_subtitle],
                ["hero_cta_experience", payload.hero_cta_experience],
                ["hero_cta_certifications", payload.hero_cta_certifications],
            ];

            for (const [key, value] of entries) {
                await env.DB.prepare(
                    "INSERT OR REPLACE INTO site_content (key, value) VALUES (?, ?)",
                )
                    .bind(key, value)
                    .run();
            }
            return Astro.redirect("/admin/content?saved=1");
        }
    } catch (e: any) {
        console.error(e);
        errorMessage = errorMessage || e?.message || "Erro ao salvar textos.";
    }
}

const content = await loadContent();
---

<AdminLayout title="Textos do Site">
    <h1 class="text-3xl font-bold mb-8">Textos do Site</h1>

    {env?.DB ? null : (
        <div class="mb-6 rounded-lg border border-yellow-700 bg-yellow-900/40 text-yellow-200 p-4">
            Conecte o D1 para salvar alterações. Por enquanto, os valores padrão serão usados.
        </div>
    )}

    {saved && (
        <div class="mb-6 rounded-lg border border-green-700 bg-green-900/40 text-green-200 p-4">
            Textos salvos com sucesso.
        </div>
    )}

    {savedImg && (
        <div class="mb-6 rounded-lg border border-green-700 bg-green-900/40 text-green-200 p-4">
            Imagem do hero atualizada com sucesso.
        </div>
    )}

    {errorMessage && (
        <div class="mb-6 rounded-lg border border-red-700 bg-red-900/40 text-red-200 p-4">
            {errorMessage}
        </div>
    )}

    <form method="POST" class="space-y-6 max-w-3xl" data-require-auth>
        <div>
            <label class="block text-sm font-medium mb-1" for="hero_title">Título do Hero</label>
            <input
                type="text"
                name="hero_title"
                id="hero_title"
                value={content.hero_title}
                class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                required
            />
        </div>
        <div>
            <label class="block text-sm font-medium mb-1" for="hero_subtitle">Subtítulo do Hero</label>
            <textarea
                name="hero_subtitle"
                id="hero_subtitle"
                rows="3"
                class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                required
            >{content.hero_subtitle}</textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium mb-1" for="hero_cta_experience">Texto CTA Experiência</label>
                <input
                    type="text"
                    name="hero_cta_experience"
                    id="hero_cta_experience"
                    value={content.hero_cta_experience}
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                    required
                />
            </div>
            <div>
                <label class="block text-sm font-medium mb-1" for="hero_cta_certifications">Texto CTA Certificações</label>
                <input
                    type="text"
                    name="hero_cta_certifications"
                    id="hero_cta_certifications"
                    value={content.hero_cta_certifications}
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                    required
                />
            </div>
        </div>
        <button class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded font-bold transition">
            Salvar
        </button>
    </form>

    <div class="mt-10 space-y-4 max-w-3xl">
        <h2 class="text-xl font-semibold">Imagem do Hero (somente .webp)</h2>
        {!hasR2 && (
            <div class="rounded-lg border border-yellow-700 bg-yellow-900/40 text-yellow-200 p-4">
                Configure o binding R2 no wrangler.toml para permitir upload da imagem.
            </div>
        )}

        {content.hero_image_key && hasR2 ? (
            <div class="flex flex-col gap-3">
                <span class="text-sm text-slate-400">Prévia atual</span>
                <img
                    src={`/uploads/${content.hero_image_key}`}
                    alt="Hero atual"
                    class="max-w-full rounded-lg border border-slate-700"
                    loading="lazy"
                />
            </div>
        ) : (
            <p class="text-slate-400 text-sm">Nenhuma imagem definida.</p>
        )}

        <form
            method="POST"
            action="/admin/hero-image"
            enctype="multipart/form-data"
            class="space-y-3"
            data-require-auth
        >
            <label class="block text-sm font-medium" for="hero-image-input">Upload de nova imagem (.webp, até 2MB)</label>
            <input
                type="file"
                name="image"
                accept="image/webp"
                required
                id="hero-image-input"
                class="block w-full text-sm bg-slate-800 border border-slate-700 rounded p-2 cursor-pointer"
            />
            <button class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded font-bold transition">
                Enviar imagem
            </button>
        </form>
    </div>
</AdminLayout>
