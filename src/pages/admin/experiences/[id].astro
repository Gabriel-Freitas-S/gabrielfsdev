---
import { z } from "zod";
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { ensureAdminTables, verifyPassword } from "../../../utils/auth";
import { ensureCoreTables } from "../../../utils/db";

const { id } = Astro.params;
const isNew = id === "new";

const { env } = Astro.locals.runtime;
let xp = {
    company: "",
    role: "",
    start_date: "",
    end_date: "",
    description: "",
    achievements: "[]",
};

let errorMessage = "";

// Handle POST (Save)
const xpSchema = z.object({
    company: z.string().min(2, "Informe a empresa."),
    role: z.string().min(2, "Informe o cargo."),
    start_date: z
        .string()
        .regex(/^\d{4}-\d{2}-\d{2}$/u, "Data inicial inválida."),
    end_date: z
        .string()
        .regex(/^$|^\d{4}-\d{2}-\d{2}$/u, "Data final inválida."),
    description: z.string().min(10, "Descrição muito curta."),
    achievements: z.string().optional().default(""),
    password: z.string().min(8, "Senha obrigatória."),
});

if (Astro.request.method === "POST") {
    try {
        await ensureAdminTables(env);
        await ensureCoreTables(env);
        const formData = await Astro.request.formData();
        const parsed = xpSchema.safeParse({
            company: formData.get("company"),
            role: formData.get("role"),
            start_date: formData.get("start_date"),
            end_date: formData.get("end_date") ?? "",
            description: formData.get("description"),
            achievements: formData.get("achievements") ?? "",
            password: formData.get("password"),
        });

        if (!parsed.success) {
            errorMessage = parsed.error.issues[0]?.message || "Dados inválidos.";
        } else {
            const { password, achievements, end_date, ...payload } = parsed.data;

            const passwordOk = await verifyPassword(password, env);
            if (!passwordOk) {
                throw new Error("Senha incorreta. Somente ações autenticadas podem alterar dados.");
            }

            const achievementsJSON = JSON.stringify(
                achievements
                    .split("\n")
                    .map((line) => line.trim())
                    .filter(Boolean),
            );

            if (isNew) {
                await env.DB.prepare(
                    "INSERT INTO experiences (company, role, start_date, end_date, description, achievements) VALUES (?, ?, ?, ?, ?, ?)",
                )
                    .bind(
                        payload.company,
                        payload.role,
                        payload.start_date,
                        end_date || null,
                        payload.description,
                        achievementsJSON,
                    )
                    .run();
            } else {
                await env.DB.prepare(
                    "UPDATE experiences SET company=?, role=?, start_date=?, end_date=?, description=?, achievements=? WHERE id=?",
                )
                    .bind(
                        payload.company,
                        payload.role,
                        payload.start_date,
                        end_date || null,
                        payload.description,
                        achievementsJSON,
                        id,
                    )
                    .run();
            }

            return Astro.redirect("/admin/experiences");
        }
    } catch (e: any) {
        console.error(e);
        errorMessage = errorMessage || e?.message || "Erro ao salvar experiência.";
    }
}

// Initial Data Fetch (Edit Mode)
if (!isNew && Astro.request.method === "GET") {
    await ensureCoreTables(env);
    const result = await env.DB.prepare(
        "SELECT * FROM experiences WHERE id = ?",
    )
        .bind(id)
        .first();
    if (result) {
        xp = result as any;
    }
}

// Format achievements for textarea (JSON to lines)
const achievementsLines = xp.achievements
    ? JSON.parse(xp.achievements as string).join("\n")
    : "";
---

<AdminLayout title={isNew ? "Nova Experiência" : "Editar Experiência"}>
    <h1 class="text-3xl font-bold mb-8">
        {isNew ? "Nova Experiência" : "Editar Experiência"}
    </h1>

    {errorMessage && (
        <div class="mb-4 rounded-lg border border-red-500/60 bg-red-500/10 text-red-200 px-4 py-3 text-sm">
            {errorMessage}
        </div>
    )}

    <form method="POST" class="max-w-3xl space-y-6" data-require-auth>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium mb-1">Empresa</label>
                <input
                    type="text"
                    name="company"
                    value={xp.company}
                    required
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Cargo</label>
                <input
                    type="text"
                    name="role"
                    value={xp.role}
                    required
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium mb-1">Data Início</label
                >
                <input
                    type="date"
                    name="start_date"
                    value={xp.start_date}
                    required
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
            </div>
            <div>
                <label class="block text-sm font-medium mb-1"
                    >Data Fim (Deixe em branco se atual)</label
                >
                <input
                    type="date"
                    name="end_date"
                    value={xp.end_date}
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium mb-1">Descrição</label>
            <textarea
                name="description"
                rows="4"
                required
                class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                >{xp.description}</textarea
            >
        </div>

        <div>
            <label class="block text-sm font-medium mb-1"
                >Conquistas (uma por linha)</label
            >
            <textarea
                name="achievements"
                rows="4"
                class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                >{achievementsLines}</textarea
            >
        </div>

        <div class="flex gap-4 pt-4">
            <button
                class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded font-bold transition"
                >Salvar</button
            >
            <a
                href="/admin/experiences"
                class="bg-slate-700 hover:bg-slate-600 px-6 py-2 rounded font-bold transition"
                >Cancelar</a
            >
        </div>
    </form>
</AdminLayout>
