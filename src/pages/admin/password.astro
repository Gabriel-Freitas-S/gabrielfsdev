---
import AdminLayout from "../../layouts/AdminLayout.astro";
const { createHash } = await import("node:crypto");

const runtime = Astro.locals.runtime;
const env = runtime?.env;

async function ensureSettings() {
    if (!env?.DB) return;
    await env.DB.prepare(
        "CREATE TABLE IF NOT EXISTS admin_settings (key TEXT PRIMARY KEY, value TEXT NOT NULL)",
    ).run();
}

async function getStoredHash() {
    if (!env?.DB) return null;
    const { results } = await env.DB.prepare(
        "SELECT value FROM admin_settings WHERE key = 'admin_password' LIMIT 1",
    ).all();
    return results?.[0]?.value || null;
}

const hash = (value: string) => createHash("sha256").update(value).digest("hex");

let success = false;
let error = "";

if (Astro.request.method === "POST") {
    try {
        await ensureSettings();
        const data = await Astro.request.formData();
        const current = String(data.get("current") || "");
        const next = String(data.get("next") || "");
        const confirm = String(data.get("confirm") || "");

        if (!next || next.length < 8) {
            throw new Error("A nova senha deve ter pelo menos 8 caracteres.");
        }
        if (next !== confirm) {
            throw new Error("As senhas não conferem.");
        }

        const envPassword = env?.ADMIN_PASSWORD;
        const storedHash = await getStoredHash();

        if (!storedHash && !envPassword) {
            throw new Error("Nenhuma senha configurada. Defina ADMIN_PASSWORD ou cadastre agora.");
        }

        const matchesStored = storedHash ? hash(current) === storedHash : false;
        const matchesEnv = envPassword ? current === envPassword : false;

        if (!matchesStored && !matchesEnv) {
            throw new Error("Senha atual incorreta.");
        }

        if (!env?.DB) {
            throw new Error("Banco D1 não disponível para salvar a senha.");
        }

        await env.DB.prepare(
            "INSERT OR REPLACE INTO admin_settings (key, value) VALUES ('admin_password', ?)",
        )
            .bind(hash(next))
            .run();

        success = true;
    } catch (e: any) {
        console.error(e);
        error = e?.message || "Erro ao atualizar senha.";
    }
}
---

<AdminLayout title="Alterar Senha">
    <div class="max-w-xl mx-auto space-y-6">
        <div class="card p-6">
            <h1 class="text-2xl font-bold mb-4">Alterar senha</h1>
            <p class="text-muted text-sm mb-6">
                A senha é usada para acesso ao dashboard. Ela fica armazenada apenas no D1 (hash SHA-256).
            </p>

            {success && (
                <div class="mb-4 rounded-lg border border-green-600/60 bg-green-500/10 text-green-200 px-4 py-3 text-sm">
                    Senha atualizada com sucesso. Use a nova senha no próximo login.
                </div>
            )}

            {error && (
                <div class="mb-4 rounded-lg border border-red-500/60 bg-red-500/10 text-red-200 px-4 py-3 text-sm">
                    {error}
                </div>
            )}

            <form method="POST" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1" for="current_password">Senha atual</label>
                    <input
                        type="password"
                        name="current"
                        id="current_password"
                        required
                        class="w-full surface rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[color:var(--accent)]"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1" for="new_password">Nova senha</label>
                    <input
                        type="password"
                        name="next"
                        id="new_password"
                        required
                        minlength="8"
                        class="w-full surface rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[color:var(--accent)]"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1" for="confirm_password">Confirmar nova senha</label>
                    <input
                        type="password"
                        name="confirm"
                        id="confirm_password"
                        required
                        minlength="8"
                        class="w-full surface rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[color:var(--accent)]"
                    />
                </div>
                <button class="btn btn-primary">Salvar nova senha</button>
            </form>
        </div>
    </div>
</AdminLayout>
