---
import { z } from "zod";
import AdminLayout from "../../layouts/AdminLayout.astro";
import {
    ensureAdminTables,
    generateTwoFactorSecret,
    getTwoFactorSecret,
    otpAuthURI,
    savePasswordHash,
    saveTwoFactorSecret,
    sha256Hex,
    verifyTOTP,
    verifyPassword,
} from "../../utils/auth";

const runtime = Astro.locals.runtime;
const env = runtime?.env;

const passwordSchema = z
    .object({
        password: z.string().min(8, "Informe a senha atual."),
        next: z.string().min(8, "A nova senha deve ter pelo menos 8 caracteres."),
        confirm: z.string().min(8, "Confirme a nova senha."),
        code: z
            .string()
            .trim()
            .transform((val) => val.replace(/\s+/g, ""))
            .refine((val) => /^[0-9]{6}$/.test(val), {
                message: "Informe o código 2FA válido.",
            }),
    })
    .refine((data) => data.next === data.confirm, {
        message: "As senhas não conferem.",
        path: ["confirm"],
    });

const rotateSchema = z.object({
    password: z.string().min(8, "Informe a senha para girar o 2FA."),
});

let success = false;
let error = "";
let secretRotated = false;
let currentSecret = await getTwoFactorSecret(env);
const envSecret = env?.ADMIN_TOTP_SECRET
    ? String(env.ADMIN_TOTP_SECRET).replace(/\s+/g, "").toUpperCase()
    : null;
const secretFromEnv = Boolean(envSecret && currentSecret === envSecret);
let otpUri = currentSecret ? otpAuthURI(currentSecret, "gabrielfs-admin", "gabrielfs.dev") : "";
let secretGenerated = false;
let otpValidated = false;

if (Astro.request.method === "POST") {
    try {
        await ensureAdminTables(env);
        const data = await Astro.request.formData();
        const action = String(data.get("action") || "password");

        if (action === "password") {
            const parsed = passwordSchema.safeParse({
                password: data.get("password") || data.get("current"),
                next: data.get("next"),
                confirm: data.get("confirm"),
                code: data.get("code"),
            });

            if (!parsed.success) {
                error = parsed.error.issues[0]?.message || "Dados inválidos.";
            } else {
                const passwordOk = await verifyPassword(parsed.data.password, env);
                if (!passwordOk) {
                    throw new Error("Senha atual incorreta.");
                }

                if (!currentSecret) {
                    throw new Error("Ative o 2FA antes de alterar a senha.");
                }

                const totpOk = await verifyTOTP(currentSecret, parsed.data.code);
                if (!totpOk) {
                    throw new Error("Código 2FA inválido ou expirado.");
                }

                await savePasswordHash(env, await sha256Hex(parsed.data.next));
                success = true;
            }
        }

        if (action === "rotate2fa") {
            const parsed = rotateSchema.safeParse({ password: data.get("password") });
            if (!parsed.success) {
                error = parsed.error.issues[0]?.message || "Dados inválidos.";
            } else {
                const passwordOk = await verifyPassword(parsed.data.password, env);
                if (!passwordOk) {
                    throw new Error("Senha incorreta para rotacionar o 2FA.");
                }

                const newSecret = generateTwoFactorSecret();
                await saveTwoFactorSecret(env, newSecret);
                currentSecret = newSecret;
                secretRotated = true;
                secretGenerated = true;
            }
        }

        if (action === "generate2fa") {
            const parsed = rotateSchema.safeParse({ password: data.get("password") });
            if (!parsed.success) {
                error = parsed.error.issues[0]?.message || "Dados inválidos.";
            } else {
                const passwordOk = await verifyPassword(parsed.data.password, env);
                if (!passwordOk) {
                    throw new Error("Senha incorreta para gerar o 2FA.");
                }

                const newSecret = generateTwoFactorSecret();
                await saveTwoFactorSecret(env, newSecret);
                currentSecret = newSecret;
                secretGenerated = true;
                secretRotated = false;
            }
        }

        if (action === "verify2fa") {
            const code = String(data.get("code") || "").replace(/\s+/g, "");
            const password = String(data.get("password") || "");
            if (!currentSecret) {
                throw new Error("Gere o segredo 2FA antes de validar.");
            }
            if (password.length < 8) {
                throw new Error("Informe a senha para validar o 2FA.");
            }
            const passwordOk = await verifyPassword(password, env);
            if (!passwordOk) {
                throw new Error("Senha incorreta para validar o 2FA.");
            }
            const totpOk = await verifyTOTP(currentSecret, code);
            if (!totpOk) {
                throw new Error("Código 2FA inválido. Confirme se o horário do dispositivo está correto.");
            }
            otpValidated = true;
        }
    } catch (e: any) {
        console.error(e);
        error = error || e?.message || "Erro ao atualizar dados.";
    }
}

otpUri = currentSecret ? otpAuthURI(currentSecret, "gabrielfs-admin", "gabrielfs.dev") : "";
---

<AdminLayout title="Alterar Senha">
    <div class="max-w-xl mx-auto space-y-6">
        <div class="card p-6">
            <h1 class="text-2xl font-bold mb-4">Alterar senha</h1>
            <p class="text-muted text-sm mb-6">
                A senha é usada para acesso ao dashboard. Ela fica armazenada apenas no D1 (hash SHA-256).
            </p>

            {success && (
                <div class="mb-4 rounded-lg border border-green-600/60 bg-green-500/10 text-green-200 px-4 py-3 text-sm">
                    Senha atualizada com sucesso. Use a nova senha no próximo login.
                </div>
            )}

            {secretGenerated && (
                <div class="mb-4 rounded-lg border border-blue-600/60 bg-blue-500/10 text-blue-100 px-4 py-3 text-sm">
                    Novo segredo 2FA gerado. Adicione ao app autenticador e valide com um código.
                </div>
            )}

            {otpValidated && (
                <div class="mb-4 rounded-lg border border-green-600/60 bg-green-500/10 text-green-200 px-4 py-3 text-sm">
                    Código 2FA confirmado com sucesso.
                </div>
            )}

            {error && (
                <div class="mb-4 rounded-lg border border-red-500/60 bg-red-500/10 text-red-200 px-4 py-3 text-sm">
                    {error}
                </div>
            )}

            <form method="POST" class="space-y-4" data-require-auth data-auth2fa="true">
                <input type="hidden" name="action" value="password" />
                <div>
                    <label class="block text-sm font-medium mb-1" for="new_password">Nova senha</label>
                    <input
                        type="password"
                        name="next"
                        id="new_password"
                        autocomplete="new-password"
                        required
                        minlength="8"
                        class="w-full surface rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[color:var(--accent)]"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1" for="confirm_password">Confirmar nova senha</label>
                    <input
                        type="password"
                        name="confirm"
                        id="confirm_password"
                        autocomplete="new-password"
                        required
                        minlength="8"
                        class="w-full surface rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[color:var(--accent)]"
                    />
                </div>
                <p class="text-xs text-slate-500">Confirme com senha e código 2FA no modal.</p>
                <button class="btn btn-primary">Salvar nova senha</button>
            </form>
        </div>

        <div class="card p-6">
            <h2 class="text-xl font-semibold mb-3">Autenticação em duas etapas</h2>
            <p class="text-muted text-sm mb-4">
                O código 2FA é exigido no login e após dois dias sem atividade. Guarde o segredo no seu app autenticador.
            </p>

            {secretRotated && (
                <div class="mb-4 rounded-lg border border-green-600/60 bg-green-500/10 text-green-200 px-4 py-3 text-sm">
                    Novo segredo gerado. Atualize o app autenticador com o código abaixo.
                </div>
            )}

            {currentSecret ? (
                <div class="mb-4 space-y-2">
                    <div class="flex items-center justify-between gap-2">
                        <span class="text-sm text-slate-400">Segredo atual</span>
                        {secretFromEnv && (
                            <span class="text-xs text-yellow-300">Definido via ambiente</span>
                        )}
                    </div>
                    <div class="font-mono text-sm bg-slate-900 border border-slate-700 rounded px-3 py-2 break-all">
                        {currentSecret}
                    </div>
                    {otpUri && (
                        <a
                            href={otpUri}
                            class="text-xs text-blue-400 hover:text-blue-300 underline"
                            >Abrir no app autenticador</a
                        >
                    )}
                </div>
            ) : (
                <div class="mb-4 text-sm text-slate-400">Nenhum segredo cadastrado ainda.</div>
            )}

            <form method="POST" class="space-y-3" data-require-auth>
                <input type="hidden" name="action" value={currentSecret ? "rotate2fa" : "generate2fa"} />
                <button class="btn btn-secondary">
                    {currentSecret ? "Rotacionar segredo" : "Gerar segredo"}
                </button>
                {secretFromEnv && (
                    <p class="text-xs text-yellow-300">ADMIN_TOTP_SECRET está definido; rotacionar aqui sobrescreve o segredo salvo no D1.</p>
                )}
            </form>

            <div class="mt-6 space-y-3">
                <h3 class="text-lg font-semibold">Validar código 2FA</h3>
                <p class="text-sm text-slate-400">Depois de adicionar o segredo ao app, gere um código e valide aqui.</p>
                <form method="POST" class="space-y-3" data-require-auth>
                    <input type="hidden" name="action" value="verify2fa" />
                    <div>
                        <label class="block text-sm font-medium mb-1" for="verify_code">Código 2FA</label>
                        <input
                            type="text"
                            inputmode="numeric"
                            pattern="[0-9]{6}"
                            name="code"
                            id="verify_code"
                            autocomplete="one-time-code"
                            required
                            class="w-full surface rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[color:var(--accent)]"
                        />
                    </div>
                    <button class="btn btn-primary" disabled={secretFromEnv && !currentSecret}>
                        Validar código
                    </button>
                </form>
            </div>
        </div>
    </div>
</AdminLayout>
