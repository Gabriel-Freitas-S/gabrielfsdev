---
import { z } from "zod";
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { ensureAdminTables, verifyPassword } from "../../../utils/auth";
import { ensureCoreTables } from "../../../utils/db";

const { id } = Astro.params;
const isNew = id === "new";
const { env } = Astro.locals.runtime;

let cert = {
    title: "",
    issuer: "",
    date: "",
    hours: 0,
    url: "",
    group_name: "",
};

let errorMessage = "";

const certSchema = z.object({
    title: z.string().min(2, "Informe o título."),
    issuer: z.string().min(2, "Informe o emissor."),
    date: z
        .string()
        .regex(/^\d{4}-\d{2}-\d{2}$/u, "Data inválida."),
    hours: z.coerce.number().nonnegative(),
    url: z
        .string()
        .trim()
        .optional()
        .transform((v) => v || ""),
    group_name: z
        .string()
        .trim()
        .max(120)
        .optional()
        .transform((v) => v || ""),
    password: z.string().min(8, "Senha obrigatória."),
});

if (Astro.request.method === "POST") {
    try {
        await ensureAdminTables(env);
        await ensureCoreTables(env);
        const formData = await Astro.request.formData();
        const parsed = certSchema.safeParse({
            title: formData.get("title"),
            issuer: formData.get("issuer"),
            date: formData.get("date"),
            hours: formData.get("hours"),
            url: formData.get("url"),
            group_name: formData.get("group_name"),
            password: formData.get("password"),
        });

        if (!parsed.success) {
            errorMessage = parsed.error.issues[0]?.message || "Dados inválidos.";
        } else {
            const { password, ...payload } = parsed.data;
            const passwordOk = await verifyPassword(password, env);
            if (!passwordOk) {
                throw new Error("Senha incorreta. Somente ações autenticadas podem alterar dados.");
            }

            if (isNew) {
                await env.DB.prepare(
                    "INSERT INTO certifications (title, issuer, date, hours, url, group_name) VALUES (?, ?, ?, ?, ?, ?)",
                )
                    .bind(
                        payload.title,
                        payload.issuer,
                        payload.date,
                        payload.hours,
                        payload.url,
                        payload.group_name,
                    )
                    .run();
            } else {
                await env.DB.prepare(
                    "UPDATE certifications SET title=?, issuer=?, date=?, hours=?, url=?, group_name=? WHERE id=?",
                )
                    .bind(
                        payload.title,
                        payload.issuer,
                        payload.date,
                        payload.hours,
                        payload.url,
                        payload.group_name,
                        id,
                    )
                    .run();
            }
            return Astro.redirect("/admin/certifications");
        }
    } catch (e: any) {
        console.error(e);
        errorMessage = errorMessage || e?.message || "Erro ao salvar certificação.";
    }
}

if (!isNew && Astro.request.method === "GET") {
    await ensureCoreTables(env);
    const result = await env.DB.prepare(
        "SELECT * FROM certifications WHERE id = ?",
    )
        .bind(id)
        .first();
    if (result) cert = result as any;
}
---

<AdminLayout title={isNew ? "Nova Certificação" : "Editar Certificação"}>
    <h1 class="text-3xl font-bold mb-8">
        {isNew ? "Nova Certificação" : "Editar Certificação"}
    </h1>

    {errorMessage && (
        <div class="mb-4 rounded-lg border border-red-500/60 bg-red-500/10 text-red-200 px-4 py-3 text-sm">
            {errorMessage}
        </div>
    )}

    <form method="POST" class="max-w-2xl space-y-6" data-require-auth>
        <div>
            <label class="block text-sm font-medium mb-1">Título</label>
            <input
                type="text"
                name="title"
                value={cert.title}
                required
                class="w-full bg-slate-800 border border-slate-700 rounded p-2"
            />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium mb-1">Emissor</label>
                <input
                    type="text"
                    name="issuer"
                    value={cert.issuer}
                    required
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Data</label>
                <input
                    type="date"
                    name="date"
                    value={cert.date}
                    required
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium mb-1"
                    >Carga Horária (horas)</label
                >
                <input
                    type="number"
                    name="hours"
                    value={cert.hours}
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
            </div>
            <div>
                <label class="block text-sm font-medium mb-1"
                    >Grupo (ex: CSS)</label
                >
                <input
                    type="text"
                    name="group_name"
                    value={cert.group_name}
                    list="groups"
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
                <datalist id="groups">
                    <option value="Frontend"></option>
                    <option value="Backend"></option>
                    <option value="DevOps"></option>
                </datalist>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium mb-1"
                >URL do Certificado</label
            >
            <input
                type="url"
                name="url"
                value={cert.url}
                class="w-full bg-slate-800 border border-slate-700 rounded p-2"
            />
        </div>

        <div class="flex gap-4 pt-4">
            <button
                class="bg-purple-600 hover:bg-purple-500 px-6 py-2 rounded font-bold transition"
                >Salvar</button
            >
            <a
                href="/admin/certifications"
                class="bg-slate-700 hover:bg-slate-600 px-6 py-2 rounded font-bold transition"
                >Cancelar</a
            >
        </div>
    </form>
</AdminLayout>
