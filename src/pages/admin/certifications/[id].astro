---
import AdminLayout from "../../../layouts/AdminLayout.astro";

const { id } = Astro.params;
const isNew = id === "new";
const { env } = Astro.locals.runtime;

let cert = {
    title: "",
    issuer: "",
    date: "",
    hours: 0,
    url: "",
    group_name: "",
};

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const title = formData.get("title");
        const issuer = formData.get("issuer");
        const date = formData.get("date");
        const hours = formData.get("hours");
        const url = formData.get("url");
        const group_name = formData.get("group_name");

        if (isNew) {
            await env.DB.prepare(
                "INSERT INTO certifications (title, issuer, date, hours, url, group_name) VALUES (?, ?, ?, ?, ?, ?)",
            )
                .bind(title, issuer, date, hours, url, group_name)
                .run();
        } else {
            await env.DB.prepare(
                "UPDATE certifications SET title=?, issuer=?, date=?, hours=?, url=?, group_name=? WHERE id=?",
            )
                .bind(title, issuer, date, hours, url, group_name, id)
                .run();
        }
        return Astro.redirect("/admin/certifications");
    } catch (e) {
        console.error(e);
    }
}

if (!isNew && Astro.request.method === "GET") {
    const result = await env.DB.prepare(
        "SELECT * FROM certifications WHERE id = ?",
    )
        .bind(id)
        .first();
    if (result) cert = result as any;
}
---

<AdminLayout title={isNew ? "Nova Certificação" : "Editar Certificação"}>
    <h1 class="text-3xl font-bold mb-8">
        {isNew ? "Nova Certificação" : "Editar Certificação"}
    </h1>

    <form method="POST" class="max-w-2xl space-y-6">
        <div>
            <label class="block text-sm font-medium mb-1">Título</label>
            <input
                type="text"
                name="title"
                value={cert.title}
                required
                class="w-full bg-slate-800 border border-slate-700 rounded p-2"
            />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium mb-1">Emissor</label>
                <input
                    type="text"
                    name="issuer"
                    value={cert.issuer}
                    required
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Data</label>
                <input
                    type="date"
                    name="date"
                    value={cert.date}
                    required
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium mb-1"
                    >Carga Horária (horas)</label
                >
                <input
                    type="number"
                    name="hours"
                    value={cert.hours}
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
            </div>
            <div>
                <label class="block text-sm font-medium mb-1"
                    >Grupo (ex: CSS)</label
                >
                <input
                    type="text"
                    name="group_name"
                    value={cert.group_name}
                    list="groups"
                    class="w-full bg-slate-800 border border-slate-700 rounded p-2"
                />
                <datalist id="groups">
                    <option value="Frontend"></option>
                    <option value="Backend"></option>
                    <option value="DevOps"></option>
                </datalist>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium mb-1"
                >URL do Certificado</label
            >
            <input
                type="url"
                name="url"
                value={cert.url}
                class="w-full bg-slate-800 border border-slate-700 rounded p-2"
            />
        </div>

        <div class="flex gap-4 pt-4">
            <button
                class="bg-purple-600 hover:bg-purple-500 px-6 py-2 rounded font-bold transition"
                >Salvar</button
            >
            <a
                href="/admin/certifications"
                class="bg-slate-700 hover:bg-slate-600 px-6 py-2 rounded font-bold transition"
                >Cancelar</a
            >
        </div>
    </form>
</AdminLayout>
